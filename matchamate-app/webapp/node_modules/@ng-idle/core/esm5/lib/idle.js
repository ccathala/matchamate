import { __decorate, __metadata, __param, __values } from "tslib";
import { EventEmitter, Injectable, NgZone, OnDestroy, Optional } from '@angular/core';
import { IdleExpiry } from './idleexpiry';
import { Interrupt } from './interrupt';
import { KeepaliveSvc } from './keepalivesvc';
import { LocalStorageExpiry } from './localstorageexpiry';
/*
 * Indicates the desired auto resume behavior.
 */
export var AutoResume;
(function (AutoResume) {
    /*
     * Auto resume functionality will be disabled.
     */
    AutoResume[AutoResume["disabled"] = 0] = "disabled";
    /*
     * Can resume automatically even if they are idle.
     */
    AutoResume[AutoResume["idle"] = 1] = "idle";
    /*
     * Can only resume automatically if they are not yet idle.
     */
    AutoResume[AutoResume["notIdle"] = 2] = "notIdle";
})(AutoResume || (AutoResume = {}));
/**
 * A service for detecting and responding to user idleness.
 */
var Idle = /** @class */ (function () {
    function Idle(expiry, zone, keepaliveSvc) {
        this.expiry = expiry;
        this.zone = zone;
        this.idle = 20 * 60; // in seconds
        this.timeoutVal = 30; // in seconds
        this.autoResume = AutoResume.idle;
        this.interrupts = new Array();
        this.running = false;
        this.keepaliveEnabled = false;
        this.onIdleStart = new EventEmitter();
        this.onIdleEnd = new EventEmitter();
        this.onTimeoutWarning = new EventEmitter();
        this.onTimeout = new EventEmitter();
        this.onInterrupt = new EventEmitter();
        if (keepaliveSvc) {
            this.keepaliveSvc = keepaliveSvc;
            this.keepaliveEnabled = true;
        }
        this.setIdling(false);
    }
    /*
     * Sets the idle name for localStorage.
     * Important to set if multiple instances of Idle with LocalStorageExpiry
     * @param The name of the idle.
     */
    Idle.prototype.setIdleName = function (key) {
        if (this.expiry instanceof LocalStorageExpiry) {
            this.expiry.setIdleName(key);
        }
        else {
            throw new Error('Cannot set expiry key name because no LocalStorageExpiry has been provided.');
        }
    };
    /*
     * Returns whether or not keepalive integration is enabled.
     * @return True if integration is enabled; otherwise, false.
     */
    Idle.prototype.getKeepaliveEnabled = function () {
        return this.keepaliveEnabled;
    };
    /*
     * Sets and returns whether or not keepalive integration is enabled.
     * @param True if the integration is enabled; otherwise, false.
     * @return The current value.
     */
    Idle.prototype.setKeepaliveEnabled = function (value) {
        if (!this.keepaliveSvc) {
            throw new Error('Cannot enable keepalive integration because no KeepaliveSvc has been provided.');
        }
        return (this.keepaliveEnabled = value);
    };
    /*
     * Returns the current timeout value.
     * @return The timeout value in seconds.
     */
    Idle.prototype.getTimeout = function () {
        return this.timeoutVal;
    };
    /*
     * Sets the timeout value.
     * @param seconds - The timeout value in seconds. 0 or false to disable timeout feature.
     * @return The current value. If disabled, the value will be 0.
     */
    Idle.prototype.setTimeout = function (seconds) {
        if (seconds === false) {
            this.timeoutVal = 0;
        }
        else if (typeof seconds === 'number' && seconds >= 0) {
            this.timeoutVal = seconds;
        }
        else {
            throw new Error("'seconds' can only be 'false' or a positive number.");
        }
        return this.timeoutVal;
    };
    /*
     * Returns the current idle value.
     * @return The idle value in seconds.
     */
    Idle.prototype.getIdle = function () {
        return this.idle;
    };
    /*
     * Sets the idle value.
     * @param seconds - The idle value in seconds.
     * @return The idle value in seconds.
     */
    Idle.prototype.setIdle = function (seconds) {
        if (seconds <= 0) {
            throw new Error("'seconds' must be greater zero");
        }
        return (this.idle = seconds);
    };
    /*
     * Returns the current autoresume value.
     * @return The current value.
     */
    Idle.prototype.getAutoResume = function () {
        return this.autoResume;
    };
    Idle.prototype.setAutoResume = function (value) {
        return (this.autoResume = value);
    };
    /*
     * Sets interrupts from the specified sources.
     * @param sources - Interrupt sources.
     * @return The resulting interrupts.
     */
    Idle.prototype.setInterrupts = function (sources) {
        var e_1, _a;
        this.clearInterrupts();
        var self = this;
        try {
            for (var sources_1 = __values(sources), sources_1_1 = sources_1.next(); !sources_1_1.done; sources_1_1 = sources_1.next()) {
                var source = sources_1_1.value;
                var sub = new Interrupt(source);
                sub.subscribe(function (args) {
                    self.interrupt(args.force, args.innerArgs);
                });
                this.interrupts.push(sub);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (sources_1_1 && !sources_1_1.done && (_a = sources_1.return)) _a.call(sources_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return this.interrupts;
    };
    /*
     * Returns the current interrupts.
     * @return The current interrupts.
     */
    Idle.prototype.getInterrupts = function () {
        return this.interrupts;
    };
    /*
     * Pauses, unsubscribes, and clears the current interrupt subscriptions.
     */
    Idle.prototype.clearInterrupts = function () {
        var e_2, _a;
        try {
            for (var _b = __values(this.interrupts), _c = _b.next(); !_c.done; _c = _b.next()) {
                var sub = _c.value;
                sub.pause();
                sub.unsubscribe();
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_2) throw e_2.error; }
        }
        this.interrupts.length = 0;
    };
    /*
     * Returns whether or not the service is running i.e. watching for idleness.
     * @return True if service is watching; otherwise, false.
     */
    Idle.prototype.isRunning = function () {
        return this.running;
    };
    /*
     * Returns whether or not the user is considered idle.
     * @return True if the user is in the idle state; otherwise, false.
     */
    Idle.prototype.isIdling = function () {
        return this.idling;
    };
    /*
     * Starts watching for inactivity.
     */
    Idle.prototype.watch = function (skipExpiry) {
        var _this = this;
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        var timeout = !this.timeoutVal ? 0 : this.timeoutVal;
        if (!skipExpiry) {
            var value = new Date(this.expiry.now().getTime() + (this.idle + timeout) * 1000);
            this.expiry.last(value);
        }
        if (this.idling) {
            this.toggleState();
        }
        if (!this.running) {
            this.startKeepalive();
            this.toggleInterrupts(true);
        }
        this.running = true;
        var watchFn = function () {
            _this.zone.run(function () {
                var diff = _this.getExpiryDiff(timeout);
                if (diff > 0) {
                    _this.safeClearInterval('idleHandle');
                    _this.setIdleIntervalOutsideOfZone(watchFn, diff);
                }
                else {
                    _this.toggleState();
                }
            });
        };
        this.setIdleIntervalOutsideOfZone(watchFn, this.idle * 1000);
    };
    /*
     * Allows protractor tests to call waitForAngular without hanging
     */
    Idle.prototype.setIdleIntervalOutsideOfZone = function (watchFn, frequency) {
        var _this = this;
        this.zone.runOutsideAngular(function () {
            _this.idleHandle = setInterval(watchFn, frequency);
        });
    };
    /*
     * Stops watching for inactivity.
     */
    Idle.prototype.stop = function () {
        this.stopKeepalive();
        this.toggleInterrupts(false);
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        this.setIdling(false);
        this.running = false;
        this.expiry.last(null);
    };
    /*
     * Forces a timeout event and state.
     */
    Idle.prototype.timeout = function () {
        this.stopKeepalive();
        this.toggleInterrupts(false);
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        this.setIdling(true);
        this.running = false;
        this.countdown = 0;
        this.onTimeout.emit(null);
    };
    /*
     * Signals that user activity has occurred.
     * @param force - Forces watch to be called, unless they are timed out.
     * @param eventArgs - Optional source event arguments.
     */
    Idle.prototype.interrupt = function (force, eventArgs) {
        if (!this.running) {
            return;
        }
        if (this.timeoutVal && this.expiry.isExpired()) {
            this.timeout();
            return;
        }
        this.onInterrupt.emit(eventArgs);
        if (force === true ||
            this.autoResume === AutoResume.idle ||
            (this.autoResume === AutoResume.notIdle && !this.expiry.idling())) {
            this.watch(force);
        }
    };
    Idle.prototype.setIdling = function (value) {
        this.idling = value;
        this.expiry.idling(value);
    };
    Idle.prototype.toggleState = function () {
        var _this = this;
        this.setIdling(!this.idling);
        if (this.idling) {
            this.onIdleStart.emit(null);
            this.stopKeepalive();
            if (this.timeoutVal > 0) {
                this.countdown = this.timeoutVal;
                this.doCountdown();
                this.setTimoutIntervalOutsideZone(function () {
                    _this.doCountdownInZone();
                }, 1000);
            }
        }
        else {
            this.toggleInterrupts(true);
            this.onIdleEnd.emit(null);
            this.startKeepalive();
        }
        this.safeClearInterval('idleHandle');
    };
    Idle.prototype.setTimoutIntervalOutsideZone = function (intervalFn, frequency) {
        var _this = this;
        this.zone.runOutsideAngular(function () {
            _this.timeoutHandle = setInterval(function () {
                intervalFn();
            }, frequency);
        });
    };
    Idle.prototype.toggleInterrupts = function (resume) {
        var e_3, _a;
        try {
            for (var _b = __values(this.interrupts), _c = _b.next(); !_c.done; _c = _b.next()) {
                var interrupt = _c.value;
                if (resume) {
                    interrupt.resume();
                }
                else {
                    interrupt.pause();
                }
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_3) throw e_3.error; }
        }
    };
    Idle.prototype.getExpiryDiff = function (timeout) {
        var now = this.expiry.now();
        var last = this.expiry.last() || now;
        return last.getTime() - now.getTime() - timeout * 1000;
    };
    Idle.prototype.doCountdownInZone = function () {
        var _this = this;
        this.zone.run(function () {
            _this.doCountdown();
        });
    };
    Idle.prototype.doCountdown = function () {
        var diff = this.getExpiryDiff(this.timeoutVal);
        if (diff > 0) {
            this.safeClearInterval('timeoutHandle');
            this.interrupt(true);
            return;
        }
        if (!this.idling) {
            return;
        }
        if (this.countdown <= 0) {
            this.timeout();
            return;
        }
        this.onTimeoutWarning.emit(this.countdown);
        this.countdown--;
    };
    Idle.prototype.safeClearInterval = function (handleName) {
        var handle = this[handleName];
        if (handle !== null && typeof handle !== 'undefined') {
            clearInterval(this[handleName]);
            this[handleName] = null;
        }
    };
    Idle.prototype.startKeepalive = function () {
        if (!this.keepaliveSvc || !this.keepaliveEnabled) {
            return;
        }
        if (this.running) {
            this.keepaliveSvc.ping();
        }
        this.keepaliveSvc.start();
    };
    Idle.prototype.stopKeepalive = function () {
        if (!this.keepaliveSvc || !this.keepaliveEnabled) {
            return;
        }
        this.keepaliveSvc.stop();
    };
    /*
     * Called by Angular when destroying the instance.
     */
    Idle.prototype.ngOnDestroy = function () {
        this.stop();
        this.clearInterrupts();
    };
    Idle.ctorParameters = function () { return [
        { type: IdleExpiry },
        { type: NgZone },
        { type: KeepaliveSvc, decorators: [{ type: Optional }] }
    ]; };
    Idle = __decorate([
        Injectable(),
        __param(2, Optional()),
        __metadata("design:paramtypes", [IdleExpiry,
            NgZone,
            KeepaliveSvc])
    ], Idle);
    return Idle;
}());
export { Idle };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRsZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZy1pZGxlL2NvcmUvIiwic291cmNlcyI6WyJsaWIvaWRsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFlBQVksRUFDWixVQUFVLEVBQ1YsTUFBTSxFQUNOLFNBQVMsRUFDVCxRQUFRLEVBQ1QsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBR3hDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUUxRDs7R0FFRztBQUNILE1BQU0sQ0FBTixJQUFZLFVBYVg7QUFiRCxXQUFZLFVBQVU7SUFDcEI7O09BRUc7SUFDSCxtREFBUSxDQUFBO0lBQ1I7O09BRUc7SUFDSCwyQ0FBSSxDQUFBO0lBQ0o7O09BRUc7SUFDSCxpREFBTyxDQUFBO0FBQ1QsQ0FBQyxFQWJXLFVBQVUsS0FBVixVQUFVLFFBYXJCO0FBRUQ7O0dBRUc7QUFFSDtJQXFCRSxjQUNVLE1BQWtCLEVBQ2xCLElBQVksRUFDUixZQUEyQjtRQUYvQixXQUFNLEdBQU4sTUFBTSxDQUFZO1FBQ2xCLFNBQUksR0FBSixJQUFJLENBQVE7UUF0QmQsU0FBSSxHQUFXLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxhQUFhO1FBQ3JDLGVBQVUsR0FBRyxFQUFFLENBQUMsQ0FBQyxhQUFhO1FBQzlCLGVBQVUsR0FBZSxVQUFVLENBQUMsSUFBSSxDQUFDO1FBQ3pDLGVBQVUsR0FBcUIsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUMzQyxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBS2hCLHFCQUFnQixHQUFHLEtBQUssQ0FBQztRQUcxQixnQkFBVyxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ3BELGNBQVMs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QkFBZ0IsRUFBRTtZQUNoRCxPQUFPO1NBQ1I7UUFFRCxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDaEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUMxQjtRQUVELElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVPLDRCQUFhLEdBQXJCO1FBQ0UsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDaEQsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRUQ7O09BRUc7SUFDSCwwQkFBVyxHQUFYO1FBQ0UsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ1osSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQ3pCLENBQUM7O2dCQXRZaUIsVUFBVTtnQkFDWixNQUFNO2dCQUNPLFlBQVksdUJBQXRDLFFBQVE7O0lBeEJBLElBQUk7UUFEaEIsVUFBVSxFQUFFO1FBeUJSLFdBQUEsUUFBUSxFQUFFLENBQUE7eUNBRkssVUFBVTtZQUNaLE1BQU07WUFDTyxZQUFZO09BeEI5QixJQUFJLENBNlpoQjtJQUFELFdBQUM7Q0FBQSxBQTdaRCxJQTZaQztTQTdaWSxJQUFJIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRXZlbnRFbWl0dGVyLFxuICBJbmplY3RhYmxlLFxuICBOZ1pvbmUsXG4gIE9uRGVzdHJveSxcbiAgT3B0aW9uYWxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IElkbGVFeHBpcnkgfSBmcm9tICcuL2lkbGVleHBpcnknO1xuaW1wb3J0IHsgSW50ZXJydXB0IH0gZnJvbSAnLi9pbnRlcnJ1cHQnO1xuaW1wb3J0IHsgSW50ZXJydXB0QXJncyB9IGZyb20gJy4vaW50ZXJydXB0YXJncyc7XG5pbXBvcnQgeyBJbnRlcnJ1cHRTb3VyY2UgfSBmcm9tICcuL2ludGVycnVwdHNvdXJjZSc7XG5pbXBvcnQgeyBLZWVwYWxpdmVTdmMgfSBmcm9tICcuL2tlZXBhbGl2ZXN2Yyc7XG5pbXBvcnQgeyBMb2NhbFN0b3JhZ2VFeHBpcnkgfSBmcm9tICcuL2xvY2Fsc3RvcmFnZWV4cGlyeSc7XG5cbi8qXG4gKiBJbmRpY2F0ZXMgdGhlIGRlc2lyZWQgYXV0byByZXN1bWUgYmVoYXZpb3IuXG4gKi9cbmV4cG9ydCBlbnVtIEF1dG9SZXN1bWUge1xuICAvKlxuICAgKiBBdXRvIHJlc3VtZSBmdW5jdGlvbmFsaXR5IHdpbGwgYmUgZGlzYWJsZWQuXG4gICAqL1xuICBkaXNhYmxlZCxcbiAgLypcbiAgICogQ2FuIHJlc3VtZSBhdXRvbWF0aWNhbGx5IGV2ZW4gaWYgdGhleSBhcmUgaWRsZS5cbiAgICovXG4gIGlkbGUsXG4gIC8qXG4gICAqIENhbiBvbmx5IHJlc3VtZSBhdXRvbWF0aWNhbGx5IGlmIHRoZXkgYXJlIG5vdCB5ZXQgaWRsZS5cbiAgICovXG4gIG5vdElkbGVcbn1cblxuLyoqXG4gKiBBIHNlcnZpY2UgZm9yIGRldGVjdGluZyBhbmQgcmVzcG9uZGluZyB0byB1c2VyIGlkbGVuZXNzLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgSWRsZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgaWRsZTogbnVtYmVyID0gMjAgKiA2MDsgLy8gaW4gc2Vjb25kc1xuICBwcml2YXRlIHRpbWVvdXRWYWwgPSAzMDsgLy8gaW4gc2Vjb25kc1xuICBwcml2YXRlIGF1dG9SZXN1bWU6IEF1dG9SZXN1bWUgPSBBdXRvUmVzdW1lLmlkbGU7XG4gIHByaXZhdGUgaW50ZXJydXB0czogQXJyYXk8SW50ZXJydXB0PiA9IG5ldyBBcnJheSgpO1xuICBwcml2YXRlIHJ1bm5pbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBpZGxpbmc6IGJvb2xlYW47XG4gIHByaXZhdGUgaWRsZUhhbmRsZTogYW55O1xuICBwcml2YXRlIHRpbWVvdXRIYW5kbGU6IGFueTtcbiAgcHJpdmF0ZSBjb3VudGRvd246IG51bWJlcjtcbiAgcHJpdmF0ZSBrZWVwYWxpdmVFbmFibGVkID0gZmFsc2U7XG4gIHByaXZhdGUga2VlcGFsaXZlU3ZjOiBLZWVwYWxpdmVTdmM7XG5cbiAgcHVibGljIG9uSWRsZVN0YXJ0OiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgcHVibGljIG9uSWRsZUVuZDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIHB1YmxpYyBvblRpbWVvdXRXYXJuaW5nOiBFdmVudEVtaXR0ZXI8bnVtYmVyPiA9IG5ldyBFdmVudEVtaXR0ZXI8bnVtYmVyPigpO1xuICBwdWJsaWMgb25UaW1lb3V0OiBFdmVudEVtaXR0ZXI8bnVtYmVyPiA9IG5ldyBFdmVudEVtaXR0ZXI8bnVtYmVyPigpO1xuICBwdWJsaWMgb25JbnRlcnJ1cHQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIFtrZXk6IHN0cmluZ106IGFueTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGV4cGlyeTogSWRsZUV4cGlyeSxcbiAgICBwcml2YXRlIHpvbmU6IE5nWm9uZSxcbiAgICBAT3B0aW9uYWwoKSBrZWVwYWxpdmVTdmM/OiBLZWVwYWxpdmVTdmNcbiAgKSB7XG4gICAgaWYgKGtlZXBhbGl2ZVN2Yykge1xuICAgICAgdGhpcy5rZWVwYWxpdmVTdmMgPSBrZWVwYWxpdmVTdmM7XG4gICAgICB0aGlzLmtlZXBhbGl2ZUVuYWJsZWQgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLnNldElkbGluZyhmYWxzZSk7XG4gIH1cblxuICAvKlxuICAgKiBTZXRzIHRoZSBpZGxlIG5hbWUgZm9yIGxvY2FsU3RvcmFnZS5cbiAgICogSW1wb3J0YW50IHRvIHNldCBpZiBtdWx0aXBsZSBpbnN0YW5jZXMgb2YgSWRsZSB3aXRoIExvY2FsU3RvcmFnZUV4cGlyeVxuICAgKiBAcGFyYW0gVGhlIG5hbWUgb2YgdGhlIGlkbGUuXG4gICAqL1xuICBzZXRJZGxlTmFtZShrZXk6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLmV4cGlyeSBpbnN0YW5jZW9mIExvY2FsU3RvcmFnZUV4cGlyeSkge1xuICAgICAgdGhpcy5leHBpcnkuc2V0SWRsZU5hbWUoa2V5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnQ2Fubm90IHNldCBleHBpcnkga2V5IG5hbWUgYmVjYXVzZSBubyBMb2NhbFN0b3JhZ2VFeHBpcnkgaGFzIGJlZW4gcHJvdmlkZWQuJ1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHdoZXRoZXIgb3Igbm90IGtlZXBhbGl2ZSBpbnRlZ3JhdGlvbiBpcyBlbmFibGVkLlxuICAgKiBAcmV0dXJuIFRydWUgaWYgaW50ZWdyYXRpb24gaXMgZW5hYmxlZDsgb3RoZXJ3aXNlLCBmYWxzZS5cbiAgICovXG4gIGdldEtlZXBhbGl2ZUVuYWJsZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMua2VlcGFsaXZlRW5hYmxlZDtcbiAgfVxuXG4gIC8qXG4gICAqIFNldHMgYW5kIHJldHVybnMgd2hldGhlciBvciBub3Qga2VlcGFsaXZlIGludGVncmF0aW9uIGlzIGVuYWJsZWQuXG4gICAqIEBwYXJhbSBUcnVlIGlmIHRoZSBpbnRlZ3JhdGlvbiBpcyBlbmFibGVkOyBvdGhlcndpc2UsIGZhbHNlLlxuICAgKiBAcmV0dXJuIFRoZSBjdXJyZW50IHZhbHVlLlxuICAgKi9cbiAgc2V0S2VlcGFsaXZlRW5hYmxlZCh2YWx1ZTogYm9vbGVhbik6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5rZWVwYWxpdmVTdmMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0Nhbm5vdCBlbmFibGUga2VlcGFsaXZlIGludGVncmF0aW9uIGJlY2F1c2Ugbm8gS2VlcGFsaXZlU3ZjIGhhcyBiZWVuIHByb3ZpZGVkLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuICh0aGlzLmtlZXBhbGl2ZUVuYWJsZWQgPSB2YWx1ZSk7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHRpbWVvdXQgdmFsdWUuXG4gICAqIEByZXR1cm4gVGhlIHRpbWVvdXQgdmFsdWUgaW4gc2Vjb25kcy5cbiAgICovXG4gIGdldFRpbWVvdXQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy50aW1lb3V0VmFsO1xuICB9XG5cbiAgLypcbiAgICogU2V0cyB0aGUgdGltZW91dCB2YWx1ZS5cbiAgICogQHBhcmFtIHNlY29uZHMgLSBUaGUgdGltZW91dCB2YWx1ZSBpbiBzZWNvbmRzLiAwIG9yIGZhbHNlIHRvIGRpc2FibGUgdGltZW91dCBmZWF0dXJlLlxuICAgKiBAcmV0dXJuIFRoZSBjdXJyZW50IHZhbHVlLiBJZiBkaXNhYmxlZCwgdGhlIHZhbHVlIHdpbGwgYmUgMC5cbiAgICovXG4gIHNldFRpbWVvdXQoc2Vjb25kczogbnVtYmVyIHwgYm9vbGVhbik6IG51bWJlciB7XG4gICAgaWYgKHNlY29uZHMgPT09IGZhbHNlKSB7XG4gICAgICB0aGlzLnRpbWVvdXRWYWwgPSAwO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHNlY29uZHMgPT09ICdudW1iZXInICYmIHNlY29uZHMgPj0gMCkge1xuICAgICAgdGhpcy50aW1lb3V0VmFsID0gc2Vjb25kcztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiJ3NlY29uZHMnIGNhbiBvbmx5IGJlICdmYWxzZScgb3IgYSBwb3NpdGl2ZSBudW1iZXIuXCIpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnRpbWVvdXRWYWw7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IGlkbGUgdmFsdWUuXG4gICAqIEByZXR1cm4gVGhlIGlkbGUgdmFsdWUgaW4gc2Vjb25kcy5cbiAgICovXG4gIGdldElkbGUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5pZGxlO1xuICB9XG5cbiAgLypcbiAgICogU2V0cyB0aGUgaWRsZSB2YWx1ZS5cbiAgICogQHBhcmFtIHNlY29uZHMgLSBUaGUgaWRsZSB2YWx1ZSBpbiBzZWNvbmRzLlxuICAgKiBAcmV0dXJuIFRoZSBpZGxlIHZhbHVlIGluIHNlY29uZHMuXG4gICAqL1xuICBzZXRJZGxlKHNlY29uZHM6IG51bWJlcik6IG51bWJlciB7XG4gICAgaWYgKHNlY29uZHMgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiJ3NlY29uZHMnIG11c3QgYmUgZ3JlYXRlciB6ZXJvXCIpO1xuICAgIH1cblxuICAgIHJldHVybiAodGhpcy5pZGxlID0gc2Vjb25kcyk7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IGF1dG9yZXN1bWUgdmFsdWUuXG4gICAqIEByZXR1cm4gVGhlIGN1cnJlbnQgdmFsdWUuXG4gICAqL1xuICBnZXRBdXRvUmVzdW1lKCk6IEF1dG9SZXN1bWUge1xuICAgIHJldHVybiB0aGlzLmF1dG9SZXN1bWU7XG4gIH1cblxuICBzZXRBdXRvUmVzdW1lKHZhbHVlOiBBdXRvUmVzdW1lKTogQXV0b1Jlc3VtZSB7XG4gICAgcmV0dXJuICh0aGlzLmF1dG9SZXN1bWUgPSB2YWx1ZSk7XG4gIH1cblxuICAvKlxuICAgKiBTZXRzIGludGVycnVwdHMgZnJvbSB0aGUgc3BlY2lmaWVkIHNvdXJjZXMuXG4gICAqIEBwYXJhbSBzb3VyY2VzIC0gSW50ZXJydXB0IHNvdXJjZXMuXG4gICAqIEByZXR1cm4gVGhlIHJlc3VsdGluZyBpbnRlcnJ1cHRzLlxuICAgKi9cbiAgc2V0SW50ZXJydXB0cyhzb3VyY2VzOiBBcnJheTxJbnRlcnJ1cHRTb3VyY2U+KTogQXJyYXk8SW50ZXJydXB0PiB7XG4gICAgdGhpcy5jbGVhckludGVycnVwdHMoKTtcblxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gICAgZm9yIChjb25zdCBzb3VyY2Ugb2Ygc291cmNlcykge1xuICAgICAgY29uc3Qgc3ViID0gbmV3IEludGVycnVwdChzb3VyY2UpO1xuICAgICAgc3ViLnN1YnNjcmliZSgoYXJnczogSW50ZXJydXB0QXJncykgPT4ge1xuICAgICAgICBzZWxmLmludGVycnVwdChhcmdzLmZvcmNlLCBhcmdzLmlubmVyQXJncyk7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5pbnRlcnJ1cHRzLnB1c2goc3ViKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5pbnRlcnJ1cHRzO1xuICB9XG5cbiAgLypcbiAgICogUmV0dXJucyB0aGUgY3VycmVudCBpbnRlcnJ1cHRzLlxuICAgKiBAcmV0dXJuIFRoZSBjdXJyZW50IGludGVycnVwdHMuXG4gICAqL1xuICBnZXRJbnRlcnJ1cHRzKCk6IEFycmF5PEludGVycnVwdD4ge1xuICAgIHJldHVybiB0aGlzLmludGVycnVwdHM7XG4gIH1cblxuICAvKlxuICAgKiBQYXVzZXMsIHVuc3Vic2NyaWJlcywgYW5kIGNsZWFycyB0aGUgY3VycmVudCBpbnRlcnJ1cHQgc3Vic2NyaXB0aW9ucy5cbiAgICovXG4gIGNsZWFySW50ZXJydXB0cygpOiB2b2lkIHtcbiAgICBmb3IgKGNvbnN0IHN1YiBvZiB0aGlzLmludGVycnVwdHMpIHtcbiAgICAgIHN1Yi5wYXVzZSgpO1xuICAgICAgc3ViLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgdGhpcy5pbnRlcnJ1cHRzLmxlbmd0aCA9IDA7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHdoZXRoZXIgb3Igbm90IHRoZSBzZXJ2aWNlIGlzIHJ1bm5pbmcgaS5lLiB3YXRjaGluZyBmb3IgaWRsZW5lc3MuXG4gICAqIEByZXR1cm4gVHJ1ZSBpZiBzZXJ2aWNlIGlzIHdhdGNoaW5nOyBvdGhlcndpc2UsIGZhbHNlLlxuICAgKi9cbiAgaXNSdW5uaW5nKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnJ1bm5pbmc7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHdoZXRoZXIgb3Igbm90IHRoZSB1c2VyIGlzIGNvbnNpZGVyZWQgaWRsZS5cbiAgICogQHJldHVybiBUcnVlIGlmIHRoZSB1c2VyIGlzIGluIHRoZSBpZGxlIHN0YXRlOyBvdGhlcndpc2UsIGZhbHNlLlxuICAgKi9cbiAgaXNJZGxpbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaWRsaW5nO1xuICB9XG5cbiAgLypcbiAgICogU3RhcnRzIHdhdGNoaW5nIGZvciBpbmFjdGl2aXR5LlxuICAgKi9cbiAgd2F0Y2goc2tpcEV4cGlyeT86IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCdpZGxlSGFuZGxlJyk7XG4gICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgndGltZW91dEhhbmRsZScpO1xuXG4gICAgY29uc3QgdGltZW91dCA9ICF0aGlzLnRpbWVvdXRWYWwgPyAwIDogdGhpcy50aW1lb3V0VmFsO1xuICAgIGlmICghc2tpcEV4cGlyeSkge1xuICAgICAgY29uc3QgdmFsdWUgPSBuZXcgRGF0ZShcbiAgICAgICAgdGhpcy5leHBpcnkubm93KCkuZ2V0VGltZSgpICsgKHRoaXMuaWRsZSArIHRpbWVvdXQpICogMTAwMFxuICAgICAgKTtcbiAgICAgIHRoaXMuZXhwaXJ5Lmxhc3QodmFsdWUpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlkbGluZykge1xuICAgICAgdGhpcy50b2dnbGVTdGF0ZSgpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMucnVubmluZykge1xuICAgICAgdGhpcy5zdGFydEtlZXBhbGl2ZSgpO1xuICAgICAgdGhpcy50b2dnbGVJbnRlcnJ1cHRzKHRydWUpO1xuICAgIH1cblxuICAgIHRoaXMucnVubmluZyA9IHRydWU7XG5cbiAgICBjb25zdCB3YXRjaEZuID0gKCkgPT4ge1xuICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICAgIGNvbnN0IGRpZmYgPSB0aGlzLmdldEV4cGlyeURpZmYodGltZW91dCk7XG4gICAgICAgIGlmIChkaWZmID4gMCkge1xuICAgICAgICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ2lkbGVIYW5kbGUnKTtcbiAgICAgICAgICB0aGlzLnNldElkbGVJbnRlcnZhbE91dHNpZGVPZlpvbmUod2F0Y2hGbiwgZGlmZik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy50b2dnbGVTdGF0ZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgdGhpcy5zZXRJZGxlSW50ZXJ2YWxPdXRzaWRlT2Zab25lKHdhdGNoRm4sIHRoaXMuaWRsZSAqIDEwMDApO1xuICB9XG5cbiAgLypcbiAgICogQWxsb3dzIHByb3RyYWN0b3IgdGVzdHMgdG8gY2FsbCB3YWl0Rm9yQW5ndWxhciB3aXRob3V0IGhhbmdpbmdcbiAgICovXG4gIHNldElkbGVJbnRlcnZhbE91dHNpZGVPZlpvbmUod2F0Y2hGbjogKCkgPT4gdm9pZCwgZnJlcXVlbmN5OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgdGhpcy5pZGxlSGFuZGxlID0gc2V0SW50ZXJ2YWwod2F0Y2hGbiwgZnJlcXVlbmN5KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qXG4gICAqIFN0b3BzIHdhdGNoaW5nIGZvciBpbmFjdGl2aXR5LlxuICAgKi9cbiAgc3RvcCgpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3BLZWVwYWxpdmUoKTtcblxuICAgIHRoaXMudG9nZ2xlSW50ZXJydXB0cyhmYWxzZSk7XG5cbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCdpZGxlSGFuZGxlJyk7XG4gICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgndGltZW91dEhhbmRsZScpO1xuXG4gICAgdGhpcy5zZXRJZGxpbmcoZmFsc2UpO1xuICAgIHRoaXMucnVubmluZyA9IGZhbHNlO1xuXG4gICAgdGhpcy5leHBpcnkubGFzdChudWxsKTtcbiAgfVxuXG4gIC8qXG4gICAqIEZvcmNlcyBhIHRpbWVvdXQgZXZlbnQgYW5kIHN0YXRlLlxuICAgKi9cbiAgdGltZW91dCgpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3BLZWVwYWxpdmUoKTtcblxuICAgIHRoaXMudG9nZ2xlSW50ZXJydXB0cyhmYWxzZSk7XG5cbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCdpZGxlSGFuZGxlJyk7XG4gICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgndGltZW91dEhhbmRsZScpO1xuXG4gICAgdGhpcy5zZXRJZGxpbmcodHJ1ZSk7XG4gICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7XG4gICAgdGhpcy5jb3VudGRvd24gPSAwO1xuXG4gICAgdGhpcy5vblRpbWVvdXQuZW1pdChudWxsKTtcbiAgfVxuXG4gIC8qXG4gICAqIFNpZ25hbHMgdGhhdCB1c2VyIGFjdGl2aXR5IGhhcyBvY2N1cnJlZC5cbiAgICogQHBhcmFtIGZvcmNlIC0gRm9yY2VzIHdhdGNoIHRvIGJlIGNhbGxlZCwgdW5sZXNzIHRoZXkgYXJlIHRpbWVkIG91dC5cbiAgICogQHBhcmFtIGV2ZW50QXJncyAtIE9wdGlvbmFsIHNvdXJjZSBldmVudCBhcmd1bWVudHMuXG4gICAqL1xuICBpbnRlcnJ1cHQoZm9yY2U/OiBib29sZWFuLCBldmVudEFyZ3M/OiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMucnVubmluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnRpbWVvdXRWYWwgJiYgdGhpcy5leHBpcnkuaXNFeHBpcmVkKCkpIHtcbiAgICAgIHRoaXMudGltZW91dCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLm9uSW50ZXJydXB0LmVtaXQoZXZlbnRBcmdzKTtcblxuICAgIGlmIChcbiAgICAgIGZvcmNlID09PSB0cnVlIHx8XG4gICAgICB0aGlzLmF1dG9SZXN1bWUgPT09IEF1dG9SZXN1bWUuaWRsZSB8fFxuICAgICAgKHRoaXMuYXV0b1Jlc3VtZSA9PT0gQXV0b1Jlc3VtZS5ub3RJZGxlICYmICF0aGlzLmV4cGlyeS5pZGxpbmcoKSlcbiAgICApIHtcbiAgICAgIHRoaXMud2F0Y2goZm9yY2UpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0SWRsaW5nKHZhbHVlOiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy5pZGxpbmcgPSB2YWx1ZTtcbiAgICB0aGlzLmV4cGlyeS5pZGxpbmcodmFsdWUpO1xuICB9XG5cbiAgcHJpdmF0ZSB0b2dnbGVTdGF0ZSgpOiB2b2lkIHtcbiAgICB0aGlzLnNldElkbGluZyghdGhpcy5pZGxpbmcpO1xuXG4gICAgaWYgKHRoaXMuaWRsaW5nKSB7XG4gICAgICB0aGlzLm9uSWRsZVN0YXJ0LmVtaXQobnVsbCk7XG4gICAgICB0aGlzLnN0b3BLZWVwYWxpdmUoKTtcblxuICAgICAgaWYgKHRoaXMudGltZW91dFZhbCA+IDApIHtcbiAgICAgICAgdGhpcy5jb3VudGRvd24gPSB0aGlzLnRpbWVvdXRWYWw7XG4gICAgICAgIHRoaXMuZG9Db3VudGRvd24oKTtcbiAgICAgICAgdGhpcy5zZXRUaW1vdXRJbnRlcnZhbE91dHNpZGVab25lKCgpID0+IHtcbiAgICAgICAgICB0aGlzLmRvQ291bnRkb3duSW5ab25lKCk7XG4gICAgICAgIH0sIDEwMDApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRvZ2dsZUludGVycnVwdHModHJ1ZSk7XG4gICAgICB0aGlzLm9uSWRsZUVuZC5lbWl0KG51bGwpO1xuICAgICAgdGhpcy5zdGFydEtlZXBhbGl2ZSgpO1xuICAgIH1cblxuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ2lkbGVIYW5kbGUnKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0VGltb3V0SW50ZXJ2YWxPdXRzaWRlWm9uZShcbiAgICBpbnRlcnZhbEZuOiAoKSA9PiB2b2lkLFxuICAgIGZyZXF1ZW5jeTogbnVtYmVyXG4gICkge1xuICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICB0aGlzLnRpbWVvdXRIYW5kbGUgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgIGludGVydmFsRm4oKTtcbiAgICAgIH0sIGZyZXF1ZW5jeSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHRvZ2dsZUludGVycnVwdHMocmVzdW1lOiBib29sZWFuKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBpbnRlcnJ1cHQgb2YgdGhpcy5pbnRlcnJ1cHRzKSB7XG4gICAgICBpZiAocmVzdW1lKSB7XG4gICAgICAgIGludGVycnVwdC5yZXN1bWUoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGludGVycnVwdC5wYXVzZSgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0RXhwaXJ5RGlmZih0aW1lb3V0OiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IG5vdzogRGF0ZSA9IHRoaXMuZXhwaXJ5Lm5vdygpO1xuICAgIGNvbnN0IGxhc3Q6IERhdGUgPSB0aGlzLmV4cGlyeS5sYXN0KCkgfHwgbm93O1xuICAgIHJldHVybiBsYXN0LmdldFRpbWUoKSAtIG5vdy5nZXRUaW1lKCkgLSB0aW1lb3V0ICogMTAwMDtcbiAgfVxuXG4gIHByaXZhdGUgZG9Db3VudGRvd25JblpvbmUoKTogdm9pZCB7XG4gICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICB0aGlzLmRvQ291bnRkb3duKCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGRvQ291bnRkb3duKCk6IHZvaWQge1xuICAgIGNvbnN0IGRpZmYgPSB0aGlzLmdldEV4cGlyeURpZmYodGhpcy50aW1lb3V0VmFsKTtcbiAgICBpZiAoZGlmZiA+IDApIHtcbiAgICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ3RpbWVvdXRIYW5kbGUnKTtcbiAgICAgIHRoaXMuaW50ZXJydXB0KHRydWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pZGxpbmcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb3VudGRvd24gPD0gMCkge1xuICAgICAgdGhpcy50aW1lb3V0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5vblRpbWVvdXRXYXJuaW5nLmVtaXQodGhpcy5jb3VudGRvd24pO1xuICAgIHRoaXMuY291bnRkb3duLS07XG4gIH1cblxuICBwcml2YXRlIHNhZmVDbGVhckludGVydmFsKGhhbmRsZU5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IGhhbmRsZSA9IHRoaXNbaGFuZGxlTmFtZV07XG4gICAgaWYgKGhhbmRsZSAhPT0gbnVsbCAmJiB0eXBlb2YgaGFuZGxlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzW2hhbmRsZU5hbWVdKTtcbiAgICAgIHRoaXNbaGFuZGxlTmFtZV0gPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RhcnRLZWVwYWxpdmUoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmtlZXBhbGl2ZVN2YyB8fCAhdGhpcy5rZWVwYWxpdmVFbmFibGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucnVubmluZykge1xuICAgICAgdGhpcy5rZWVwYWxpdmVTdmMucGluZygpO1xuICAgIH1cblxuICAgIHRoaXMua2VlcGFsaXZlU3ZjLnN0YXJ0KCk7XG4gIH1cblxuICBwcml2YXRlIHN0b3BLZWVwYWxpdmUoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmtlZXBhbGl2ZVN2YyB8fCAhdGhpcy5rZWVwYWxpdmVFbmFibGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5rZWVwYWxpdmVTdmMuc3RvcCgpO1xuICB9XG5cbiAgLypcbiAgICogQ2FsbGVkIGJ5IEFuZ3VsYXIgd2hlbiBkZXN0cm95aW5nIHRoZSBpbnN0YW5jZS5cbiAgICovXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuc3RvcCgpO1xuICAgIHRoaXMuY2xlYXJJbnRlcnJ1cHRzKCk7XG4gIH1cbn1cbiJdfQ==