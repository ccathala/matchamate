import { __decorate, __metadata, __param } from "tslib";
import { EventEmitter, Injectable, NgZone, OnDestroy, Optional } from '@angular/core';
import { IdleExpiry } from './idleexpiry';
import { Interrupt } from './interrupt';
import { KeepaliveSvc } from './keepalivesvc';
import { LocalStorageExpiry } from './localstorageexpiry';
/*
 * Indicates the desired auto resume behavior.
 */
export var AutoResume;
(function (AutoResume) {
    /*
     * Auto resume functionality will be disabled.
     */
    AutoResume[AutoResume["disabled"] = 0] = "disabled";
    /*
     * Can resume automatically even if they are idle.
     */
    AutoResume[AutoResume["idle"] = 1] = "idle";
    /*
     * Can only resume automatically if they are not yet idle.
     */
    AutoResume[AutoResume["notIdle"] = 2] = "notIdle";
})(AutoResume || (AutoResume = {}));
/**
 * A service for detecting and responding to user idleness.
 */
let Idle = class Idle {
    constructor(expiry, zone, keepaliveSvc) {
        this.expiry = expiry;
        this.zone = zone;
        this.idle = 20 * 60; // in seconds
        this.timeoutVal = 30; // in seconds
        this.autoResume = AutoResume.idle;
        this.interrupts = new Array();
        this.running = false;
        this.keepaliveEnabled = false;
        this.onIdleStart = new EventEmitter();
        this.onIdleEnd = new EventEmitter();
        this.onTimeoutWarning = new EventEmitter();
        this.onTimeout = new EventEmitter();
        this.onInterrupt = new EventEmitter();
        if (keepaliveSvc) {
            this.keepaliveSvc = keepaliveSvc;
            this.keepaliveEnabled = true;
        }
        this.setIdling(false);
    }
    /*
     * Sets the idle name for localStorage.
     * Important to set if multiple instances of Idle with LocalStorageExpiry
     * @param The name of the idle.
     */
    setIdleName(key) {
        if (this.expiry instanceof LocalStorageExpiry) {
            this.expiry.setIdleName(key);
        }
        else {
            throw new Error('Cannot set expiry key name because no LocalStorageExpiry has been provided.');
        }
    }
    /*
     * Returns whether or not keepalive integration is enabled.
     * @return True if integration is enabled; otherwise, false.
     */
    getKeepaliveEnabled() {
        return this.keepaliveEnabled;
    }
    /*
     * Sets and returns whether or not keepalive integration is enabled.
     * @param True if the integration is enabled; otherwise, false.
     * @return The current value.
     */
    setKeepaliveEnabled(value) {
        if (!this.keepaliveSvc) {
            throw new Error('Cannot enable keepalive integration because no KeepaliveSvc has been provided.');
        }
        return (this.keepaliveEnabled = value);
    }
    /*
     * Returns the current timeout value.
     * @return The timeout value in seconds.
     */
    getTimeout() {
        return this.timeoutVal;
    }
    /*
     * Sets the timeout value.
     * @param seconds - The timeout value in seconds. 0 or false to disable timeout feature.
     * @return The current value. If disabled, the value will be 0.
     */
    setTimeout(seconds) {
        if (seconds === false) {
            this.timeoutVal = 0;
        }
        else if (typeof seconds === 'number' && seconds >= 0) {
            this.timeoutVal = seconds;
        }
        else {
            throw new Error("'seconds' can only be 'false' or a positive number.");
        }
        return this.timeoutVal;
    }
    /*
     * Returns the current idle value.
     * @return The idle value in seconds.
     */
    getIdle() {
        return this.idle;
    }
    /*
     * Sets the idle value.
     * @param seconds - The idle value in seconds.
     * @return The idle value in seconds.
     */
    setIdle(seconds) {
        if (seconds <= 0) {
            throw new Error("'seconds' must be greater zero");
        }
        return (this.idle = seconds);
    }
    /*
     * Returns the current autoresume value.
     * @return The current value.
     */
    getAutoResume() {
        return this.autoResume;
    }
    setAutoResume(value) {
        return (this.autoResume = value);
    }
    /*
     * Sets interrupts from the specified sources.
     * @param sources - Interrupt sources.
     * @return The resulting interrupts.
     */
    setInterrupts(sources) {
        this.clearInterrupts();
        const self = this;
        for (const source of sources) {
            const sub = new Interrupt(source);
            sub.subscribe((args) => {
                self.interrupt(args.force, args.innerArgs);
            });
            this.interrupts.push(sub);
        }
        return this.interrupts;
    }
    /*
     * Returns the current interrupts.
     * @return The current interrupts.
     */
    getInterrupts() {
        return this.interrupts;
    }
    /*
     * Pauses, unsubscribes, and clears the current interrupt subscriptions.
     */
    clearInterrupts() {
        for (const sub of this.interrupts) {
            sub.pause();
            sub.unsubscribe();
        }
        this.interrupts.length = 0;
    }
    /*
     * Returns whether or not the service is running i.e. watching for idleness.
     * @return True if service is watching; otherwise, false.
     */
    isRunning() {
        return this.running;
    }
    /*
     * Returns whether or not the user is considered idle.
     * @return True if the user is in the idle state; otherwise, false.
     */
    isIdling() {
        return this.idling;
    }
    /*
     * Starts watching for inactivity.
     */
    watch(skipExpiry) {
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        const timeout = !this.timeoutVal ? 0 : this.timeoutVal;
        if (!skipExpiry) {
            const value = new Date(this.expiry.now().getTime() + (this.idle + timeout) * 1000);
            this.expiry.last(value);
        }
        if (this.idling) {
            this.toggleState();
        }
        if (!this.running) {
            this.startKeepalive();
            this.toggleInterrupts(true);
        }
        this.running = true;
        const watchFn = () => {
            this.zone.run(() => {
                const diff = this.getExpiryDiff(timeout);
                if (diff > 0) {
                    this.safeClearInterval('idleHandle');
                    this.setIdleIntervalOutsideOfZone(watchFn, diff);
                }
                else {
                    this.toggleState();
                }
            });
        };
        this.setIdleIntervalOutsideOfZone(watchFn, this.idle * 1000);
    }
    /*
     * Allows protractor tests to call waitForAngular without hanging
     */
    setIdleIntervalOutsideOfZone(watchFn, frequency) {
        this.zone.runOutsideAngular(() => {
            this.idleHandle = setInterval(watchFn, frequency);
        });
    }
    /*
     * Stops watching for inactivity.
     */
    stop() {
        this.stopKeepalive();
        this.toggleInterrupts(false);
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        this.setIdling(false);
        this.running = false;
        this.expiry.last(null);
    }
    /*
     * Forces a timeout event and state.
     */
    timeout() {
        this.stopKeepalive();
        this.toggleInterrupts(false);
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        this.setIdling(true);
        this.running = false;
        this.countdown = 0;
        this.onTimeout.emit(null);
    }
    /*
     * Signals that user activity has occurred.
     * @param force - Forces watch to be called, unless they are timed out.
     * @param eventArgs - Optional source event arguments.
     */
    interrupt(force, eventArgs) {
        if (!this.running) {
            return;
        }
        if (this.timeoutVal && this.expiry.isExpired()) {
            this.timeout();
            return;
        }
        this.onInterrupt.emit(eventArgs);
        if (force === true ||
            this.autoResume === AutoResume.idle ||
            (this.autoResume === AutoResume.notIdle && !this.expiry.idling())) {
            this.watch(force);
        }
    }
    setIdling(value) {
        this.idling = value;
        this.expiry.idling(value);
    }
    toggleState() {
        this.setIdling(!this.idling);
        if (this.idling) {
            this.onIdleStart.emit(null);
            this.stopKeepalive();
            if (this.timeoutVal > 0) {
                this.countdown = this.timeoutVal;
                this.doCountdown();
                this.setTimoutIntervalOutsideZone(() => {
                    this.doCountdownInZone();
                }, 1000);
            }
        }
        else {
            this.toggleInterrupts(true);
            this.onIdleEnd.emit(null);
            this.startKeepalive();
        }
        this.safeClearInterval('idleHandle');
    }
    setTimoutIntervalOutsideZone(intervalFn, frequency) {
        this.zone.runOutsideAngular(() => {
            this.timeoutHandle = setInterval(() => {
                intervalFn();
            }, frequency);
        });
    }
    toggleInterrupts(resume) {
        for (const interrupt of this.interrupts) {
            if (resume) {
                interrupt.resume();
            }
            else {
                interrupt.pause();
            }
        }
    }
    getExpiryDiff(timeout) {
        const now = this.expiry.now();
        const last = this.expiry.last() || now;
        return last.getTime() - now.getTime() - timeout * 1000;
    }
    doCountdownInZone() {
        this.zone.run(() => {
            this.doCountdown();
        });
    }
    doCountdown() {
        const diff = this.getExpiryDiff(this.timeoutVal);
        if (diff > 0) {
            this.safeClearInterval('timeoutHandle');
            this.interrupt(true);
            return;
        }
        if (!this.idling) {
            return;
        }
        if (this.countdown <= 0) {
            this.timeout();
            return;
        }
        this.onTimeoutWarning.emit(this.countdown);
        this.countdown--;
    }
    safeClearInterval(handleName) {
        const handle = this[handleName];
        if (handle !== null && typeof handle !== 'undefined') {
            clearInterval(this[handleName]);
            this[handleName] = null;
        }
    }
    startKeepalive() {
        if (!this.keepaliveSvc || !this.keepaliveEnabled) {
            return;
        }
        if (this.running) {
            this.keepaliveSvc.ping();
        }
        this.keepaliveSvc.start();
    }
    stopKeepalive() {
        if (!this.keepaliveSvc || !this.keepaliveEnabled) {
            return;
        }
        this.keepaliveSvc.stop();
    }
    /*
     * Called by Angular when destroying the instance.
     */
    ngOnDestroy() {
        this.stop();
        this.clearInterrupts();
    }
};
Idle.ctorParameters = () => [
    { type: IdleExpiry },
    { type: NgZone },
    { type: KeepaliveSvc, decorators: [{ type: Optional }] }
];
Idle = __decorate([
    Injectable(),
    __param(2, Optional()),
    __metadata("design:paramtypes", [IdleExpiry,
        NgZone,
        KeepaliveSvc])
], Idle);
export { Idle };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRsZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZy1pZGxlL2NvcmUvIiwic291cmNlcyI6WyJsaWIvaWRsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFlBQVksRUFDWixVQUFVLEVBQ1YsTUFBTSxFQUNOLFNBQVMsRUFDVCxRQUFRLEVBQ1QsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBR3hDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUUxRDs7R0FFRztBQUNILE1BQU0sQ0FBTixJQUFZLFVBYVg7QUFiRCxXQUFZLFVBQVU7SUFDcEI7O09BRUc7SUFDSCxtREFBUSxDQUFBO0lBQ1I7O09BRUc7SUFDSCwyQ0FBSSxDQUFBO0lBQ0o7O09BRUc7SUFDSCxpREFBTyxDQUFBO0FBQ1QsQ0FBQyxFQWJXLFVBQVUsS0FBVixVQUFVLFFBYXJCO0FBRUQ7O0dBRUc7QUFFSCxJQUFhLElBQUksR0FBakIsTUFBYSxJQUFJO0lBcUJmLFlBQ1UsTUFBa0IsRUFDbEIsSUFBWSxFQUNSLFlBQTJCO1FBRi9CLFdBQU0sR0FBTixNQUFNLENBQVk7UUFDbEIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQXRCZCxTQUFJLEdBQVcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLGFBQWE7UUFDckMsZUFBVSxHQUFHLEVBQUUsQ0FBQyxDQUFDLGFBQWE7UUFDOUIsZUFBVSxHQUFlLFVBQVUsQ0FBQyxJQUFJLENBQUM7UUFDekMsZUFBVSxHQUFxQixJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzNDLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFLaEIscUJBQWdCLEdBQUcsS0FBSyxDQUFDO1FBRzFCLGdCQUFXLEdBQXNCLElBQUks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QUMsSUFBSSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsV0FBVztRQUNULElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNaLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUN6QixDQUFDO0NBQ0YsQ0FBQTs7WUF2WW1CLFVBQVU7WUFDWixNQUFNO1lBQ08sWUFBWSx1QkFBdEMsUUFBUTs7QUF4QkEsSUFBSTtJQURoQixVQUFVLEVBQUU7SUF5QlIsV0FBQSxRQUFRLEVBQUUsQ0FBQTtxQ0FGSyxVQUFVO1FBQ1osTUFBTTtRQUNPLFlBQVk7R0F4QjlCLElBQUksQ0E2WmhCO1NBN1pZLElBQUkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBFdmVudEVtaXR0ZXIsXG4gIEluamVjdGFibGUsXG4gIE5nWm9uZSxcbiAgT25EZXN0cm95LFxuICBPcHRpb25hbFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgSWRsZUV4cGlyeSB9IGZyb20gJy4vaWRsZWV4cGlyeSc7XG5pbXBvcnQgeyBJbnRlcnJ1cHQgfSBmcm9tICcuL2ludGVycnVwdCc7XG5pbXBvcnQgeyBJbnRlcnJ1cHRBcmdzIH0gZnJvbSAnLi9pbnRlcnJ1cHRhcmdzJztcbmltcG9ydCB7IEludGVycnVwdFNvdXJjZSB9IGZyb20gJy4vaW50ZXJydXB0c291cmNlJztcbmltcG9ydCB7IEtlZXBhbGl2ZVN2YyB9IGZyb20gJy4va2VlcGFsaXZlc3ZjJztcbmltcG9ydCB7IExvY2FsU3RvcmFnZUV4cGlyeSB9IGZyb20gJy4vbG9jYWxzdG9yYWdlZXhwaXJ5JztcblxuLypcbiAqIEluZGljYXRlcyB0aGUgZGVzaXJlZCBhdXRvIHJlc3VtZSBiZWhhdmlvci5cbiAqL1xuZXhwb3J0IGVudW0gQXV0b1Jlc3VtZSB7XG4gIC8qXG4gICAqIEF1dG8gcmVzdW1lIGZ1bmN0aW9uYWxpdHkgd2lsbCBiZSBkaXNhYmxlZC5cbiAgICovXG4gIGRpc2FibGVkLFxuICAvKlxuICAgKiBDYW4gcmVzdW1lIGF1dG9tYXRpY2FsbHkgZXZlbiBpZiB0aGV5IGFyZSBpZGxlLlxuICAgKi9cbiAgaWRsZSxcbiAgLypcbiAgICogQ2FuIG9ubHkgcmVzdW1lIGF1dG9tYXRpY2FsbHkgaWYgdGhleSBhcmUgbm90IHlldCBpZGxlLlxuICAgKi9cbiAgbm90SWRsZVxufVxuXG4vKipcbiAqIEEgc2VydmljZSBmb3IgZGV0ZWN0aW5nIGFuZCByZXNwb25kaW5nIHRvIHVzZXIgaWRsZW5lc3MuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBJZGxlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBpZGxlOiBudW1iZXIgPSAyMCAqIDYwOyAvLyBpbiBzZWNvbmRzXG4gIHByaXZhdGUgdGltZW91dFZhbCA9IDMwOyAvLyBpbiBzZWNvbmRzXG4gIHByaXZhdGUgYXV0b1Jlc3VtZTogQXV0b1Jlc3VtZSA9IEF1dG9SZXN1bWUuaWRsZTtcbiAgcHJpdmF0ZSBpbnRlcnJ1cHRzOiBBcnJheTxJbnRlcnJ1cHQ+ID0gbmV3IEFycmF5KCk7XG4gIHByaXZhdGUgcnVubmluZyA9IGZhbHNlO1xuICBwcml2YXRlIGlkbGluZzogYm9vbGVhbjtcbiAgcHJpdmF0ZSBpZGxlSGFuZGxlOiBhbnk7XG4gIHByaXZhdGUgdGltZW91dEhhbmRsZTogYW55O1xuICBwcml2YXRlIGNvdW50ZG93bjogbnVtYmVyO1xuICBwcml2YXRlIGtlZXBhbGl2ZUVuYWJsZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBrZWVwYWxpdmVTdmM6IEtlZXBhbGl2ZVN2YztcblxuICBwdWJsaWMgb25JZGxlU3RhcnQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBwdWJsaWMgb25JZGxlRW5kOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgcHVibGljIG9uVGltZW91dFdhcm5pbmc6IEV2ZW50RW1pdHRlcjxudW1iZXI+ID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG4gIHB1YmxpYyBvblRpbWVvdXQ6IEV2ZW50RW1pdHRlcjxudW1iZXI+ID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG4gIHB1YmxpYyBvbkludGVycnVwdDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgW2tleTogc3RyaW5nXTogYW55O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZXhwaXJ5OiBJZGxlRXhwaXJ5LFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIEBPcHRpb25hbCgpIGtlZXBhbGl2ZVN2Yz86IEtlZXBhbGl2ZVN2Y1xuICApIHtcbiAgICBpZiAoa2VlcGFsaXZlU3ZjKSB7XG4gICAgICB0aGlzLmtlZXBhbGl2ZVN2YyA9IGtlZXBhbGl2ZVN2YztcbiAgICAgIHRoaXMua2VlcGFsaXZlRW5hYmxlZCA9IHRydWU7XG4gICAgfVxuICAgIHRoaXMuc2V0SWRsaW5nKGZhbHNlKTtcbiAgfVxuXG4gIC8qXG4gICAqIFNldHMgdGhlIGlkbGUgbmFtZSBmb3IgbG9jYWxTdG9yYWdlLlxuICAgKiBJbXBvcnRhbnQgdG8gc2V0IGlmIG11bHRpcGxlIGluc3RhbmNlcyBvZiBJZGxlIHdpdGggTG9jYWxTdG9yYWdlRXhwaXJ5XG4gICAqIEBwYXJhbSBUaGUgbmFtZSBvZiB0aGUgaWRsZS5cbiAgICovXG4gIHNldElkbGVOYW1lKGtleTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZXhwaXJ5IGluc3RhbmNlb2YgTG9jYWxTdG9yYWdlRXhwaXJ5KSB7XG4gICAgICB0aGlzLmV4cGlyeS5zZXRJZGxlTmFtZShrZXkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdDYW5ub3Qgc2V0IGV4cGlyeSBrZXkgbmFtZSBiZWNhdXNlIG5vIExvY2FsU3RvcmFnZUV4cGlyeSBoYXMgYmVlbiBwcm92aWRlZC4nXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgd2hldGhlciBvciBub3Qga2VlcGFsaXZlIGludGVncmF0aW9uIGlzIGVuYWJsZWQuXG4gICAqIEByZXR1cm4gVHJ1ZSBpZiBpbnRlZ3JhdGlvbiBpcyBlbmFibGVkOyBvdGhlcndpc2UsIGZhbHNlLlxuICAgKi9cbiAgZ2V0S2VlcGFsaXZlRW5hYmxlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5rZWVwYWxpdmVFbmFibGVkO1xuICB9XG5cbiAgLypcbiAgICogU2V0cyBhbmQgcmV0dXJucyB3aGV0aGVyIG9yIG5vdCBrZWVwYWxpdmUgaW50ZWdyYXRpb24gaXMgZW5hYmxlZC5cbiAgICogQHBhcmFtIFRydWUgaWYgdGhlIGludGVncmF0aW9uIGlzIGVuYWJsZWQ7IG90aGVyd2lzZSwgZmFsc2UuXG4gICAqIEByZXR1cm4gVGhlIGN1cnJlbnQgdmFsdWUuXG4gICAqL1xuICBzZXRLZWVwYWxpdmVFbmFibGVkKHZhbHVlOiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgaWYgKCF0aGlzLmtlZXBhbGl2ZVN2Yykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnQ2Fubm90IGVuYWJsZSBrZWVwYWxpdmUgaW50ZWdyYXRpb24gYmVjYXVzZSBubyBLZWVwYWxpdmVTdmMgaGFzIGJlZW4gcHJvdmlkZWQuJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gKHRoaXMua2VlcGFsaXZlRW5hYmxlZCA9IHZhbHVlKTtcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgdGhlIGN1cnJlbnQgdGltZW91dCB2YWx1ZS5cbiAgICogQHJldHVybiBUaGUgdGltZW91dCB2YWx1ZSBpbiBzZWNvbmRzLlxuICAgKi9cbiAgZ2V0VGltZW91dCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnRpbWVvdXRWYWw7XG4gIH1cblxuICAvKlxuICAgKiBTZXRzIHRoZSB0aW1lb3V0IHZhbHVlLlxuICAgKiBAcGFyYW0gc2Vjb25kcyAtIFRoZSB0aW1lb3V0IHZhbHVlIGluIHNlY29uZHMuIDAgb3IgZmFsc2UgdG8gZGlzYWJsZSB0aW1lb3V0IGZlYXR1cmUuXG4gICAqIEByZXR1cm4gVGhlIGN1cnJlbnQgdmFsdWUuIElmIGRpc2FibGVkLCB0aGUgdmFsdWUgd2lsbCBiZSAwLlxuICAgKi9cbiAgc2V0VGltZW91dChzZWNvbmRzOiBudW1iZXIgfCBib29sZWFuKTogbnVtYmVyIHtcbiAgICBpZiAoc2Vjb25kcyA9PT0gZmFsc2UpIHtcbiAgICAgIHRoaXMudGltZW91dFZhbCA9IDA7XG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygc2Vjb25kcyA9PT0gJ251bWJlcicgJiYgc2Vjb25kcyA+PSAwKSB7XG4gICAgICB0aGlzLnRpbWVvdXRWYWwgPSBzZWNvbmRzO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCInc2Vjb25kcycgY2FuIG9ubHkgYmUgJ2ZhbHNlJyBvciBhIHBvc2l0aXZlIG51bWJlci5cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMudGltZW91dFZhbDtcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgdGhlIGN1cnJlbnQgaWRsZSB2YWx1ZS5cbiAgICogQHJldHVybiBUaGUgaWRsZSB2YWx1ZSBpbiBzZWNvbmRzLlxuICAgKi9cbiAgZ2V0SWRsZSgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmlkbGU7XG4gIH1cblxuICAvKlxuICAgKiBTZXRzIHRoZSBpZGxlIHZhbHVlLlxuICAgKiBAcGFyYW0gc2Vjb25kcyAtIFRoZSBpZGxlIHZhbHVlIGluIHNlY29uZHMuXG4gICAqIEByZXR1cm4gVGhlIGlkbGUgdmFsdWUgaW4gc2Vjb25kcy5cbiAgICovXG4gIHNldElkbGUoc2Vjb25kczogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBpZiAoc2Vjb25kcyA8PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCInc2Vjb25kcycgbXVzdCBiZSBncmVhdGVyIHplcm9cIik7XG4gICAgfVxuXG4gICAgcmV0dXJuICh0aGlzLmlkbGUgPSBzZWNvbmRzKTtcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgdGhlIGN1cnJlbnQgYXV0b3Jlc3VtZSB2YWx1ZS5cbiAgICogQHJldHVybiBUaGUgY3VycmVudCB2YWx1ZS5cbiAgICovXG4gIGdldEF1dG9SZXN1bWUoKTogQXV0b1Jlc3VtZSB7XG4gICAgcmV0dXJuIHRoaXMuYXV0b1Jlc3VtZTtcbiAgfVxuXG4gIHNldEF1dG9SZXN1bWUodmFsdWU6IEF1dG9SZXN1bWUpOiBBdXRvUmVzdW1lIHtcbiAgICByZXR1cm4gKHRoaXMuYXV0b1Jlc3VtZSA9IHZhbHVlKTtcbiAgfVxuXG4gIC8qXG4gICAqIFNldHMgaW50ZXJydXB0cyBmcm9tIHRoZSBzcGVjaWZpZWQgc291cmNlcy5cbiAgICogQHBhcmFtIHNvdXJjZXMgLSBJbnRlcnJ1cHQgc291cmNlcy5cbiAgICogQHJldHVybiBUaGUgcmVzdWx0aW5nIGludGVycnVwdHMuXG4gICAqL1xuICBzZXRJbnRlcnJ1cHRzKHNvdXJjZXM6IEFycmF5PEludGVycnVwdFNvdXJjZT4pOiBBcnJheTxJbnRlcnJ1cHQ+IHtcbiAgICB0aGlzLmNsZWFySW50ZXJydXB0cygpO1xuXG4gICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICBmb3IgKGNvbnN0IHNvdXJjZSBvZiBzb3VyY2VzKSB7XG4gICAgICBjb25zdCBzdWIgPSBuZXcgSW50ZXJydXB0KHNvdXJjZSk7XG4gICAgICBzdWIuc3Vic2NyaWJlKChhcmdzOiBJbnRlcnJ1cHRBcmdzKSA9PiB7XG4gICAgICAgIHNlbGYuaW50ZXJydXB0KGFyZ3MuZm9yY2UsIGFyZ3MuaW5uZXJBcmdzKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmludGVycnVwdHMucHVzaChzdWIpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmludGVycnVwdHM7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IGludGVycnVwdHMuXG4gICAqIEByZXR1cm4gVGhlIGN1cnJlbnQgaW50ZXJydXB0cy5cbiAgICovXG4gIGdldEludGVycnVwdHMoKTogQXJyYXk8SW50ZXJydXB0PiB7XG4gICAgcmV0dXJuIHRoaXMuaW50ZXJydXB0cztcbiAgfVxuXG4gIC8qXG4gICAqIFBhdXNlcywgdW5zdWJzY3JpYmVzLCBhbmQgY2xlYXJzIHRoZSBjdXJyZW50IGludGVycnVwdCBzdWJzY3JpcHRpb25zLlxuICAgKi9cbiAgY2xlYXJJbnRlcnJ1cHRzKCk6IHZvaWQge1xuICAgIGZvciAoY29uc3Qgc3ViIG9mIHRoaXMuaW50ZXJydXB0cykge1xuICAgICAgc3ViLnBhdXNlKCk7XG4gICAgICBzdWIudW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICB0aGlzLmludGVycnVwdHMubGVuZ3RoID0gMDtcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgd2hldGhlciBvciBub3QgdGhlIHNlcnZpY2UgaXMgcnVubmluZyBpLmUuIHdhdGNoaW5nIGZvciBpZGxlbmVzcy5cbiAgICogQHJldHVybiBUcnVlIGlmIHNlcnZpY2UgaXMgd2F0Y2hpbmc7IG90aGVyd2lzZSwgZmFsc2UuXG4gICAqL1xuICBpc1J1bm5pbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMucnVubmluZztcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgd2hldGhlciBvciBub3QgdGhlIHVzZXIgaXMgY29uc2lkZXJlZCBpZGxlLlxuICAgKiBAcmV0dXJuIFRydWUgaWYgdGhlIHVzZXIgaXMgaW4gdGhlIGlkbGUgc3RhdGU7IG90aGVyd2lzZSwgZmFsc2UuXG4gICAqL1xuICBpc0lkbGluZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pZGxpbmc7XG4gIH1cblxuICAvKlxuICAgKiBTdGFydHMgd2F0Y2hpbmcgZm9yIGluYWN0aXZpdHkuXG4gICAqL1xuICB3YXRjaChza2lwRXhwaXJ5PzogYm9vbGVhbik6IHZvaWQge1xuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ2lkbGVIYW5kbGUnKTtcbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCd0aW1lb3V0SGFuZGxlJyk7XG5cbiAgICBjb25zdCB0aW1lb3V0ID0gIXRoaXMudGltZW91dFZhbCA/IDAgOiB0aGlzLnRpbWVvdXRWYWw7XG4gICAgaWYgKCFza2lwRXhwaXJ5KSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IG5ldyBEYXRlKFxuICAgICAgICB0aGlzLmV4cGlyeS5ub3coKS5nZXRUaW1lKCkgKyAodGhpcy5pZGxlICsgdGltZW91dCkgKiAxMDAwXG4gICAgICApO1xuICAgICAgdGhpcy5leHBpcnkubGFzdCh2YWx1ZSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaWRsaW5nKSB7XG4gICAgICB0aGlzLnRvZ2dsZVN0YXRlKCk7XG4gICAgfVxuICAgIGlmICghdGhpcy5ydW5uaW5nKSB7XG4gICAgICB0aGlzLnN0YXJ0S2VlcGFsaXZlKCk7XG4gICAgICB0aGlzLnRvZ2dsZUludGVycnVwdHModHJ1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5ydW5uaW5nID0gdHJ1ZTtcblxuICAgIGNvbnN0IHdhdGNoRm4gPSAoKSA9PiB7XG4gICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgICAgY29uc3QgZGlmZiA9IHRoaXMuZ2V0RXhwaXJ5RGlmZih0aW1lb3V0KTtcbiAgICAgICAgaWYgKGRpZmYgPiAwKSB7XG4gICAgICAgICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgnaWRsZUhhbmRsZScpO1xuICAgICAgICAgIHRoaXMuc2V0SWRsZUludGVydmFsT3V0c2lkZU9mWm9uZSh3YXRjaEZuLCBkaWZmKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLnRvZ2dsZVN0YXRlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH07XG5cbiAgICB0aGlzLnNldElkbGVJbnRlcnZhbE91dHNpZGVPZlpvbmUod2F0Y2hGbiwgdGhpcy5pZGxlICogMTAwMCk7XG4gIH1cblxuICAvKlxuICAgKiBBbGxvd3MgcHJvdHJhY3RvciB0ZXN0cyB0byBjYWxsIHdhaXRGb3JBbmd1bGFyIHdpdGhvdXQgaGFuZ2luZ1xuICAgKi9cbiAgc2V0SWRsZUludGVydmFsT3V0c2lkZU9mWm9uZSh3YXRjaEZuOiAoKSA9PiB2b2lkLCBmcmVxdWVuY3k6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICB0aGlzLmlkbGVIYW5kbGUgPSBzZXRJbnRlcnZhbCh3YXRjaEZuLCBmcmVxdWVuY3kpO1xuICAgIH0pO1xuICB9XG5cbiAgLypcbiAgICogU3RvcHMgd2F0Y2hpbmcgZm9yIGluYWN0aXZpdHkuXG4gICAqL1xuICBzdG9wKCk6IHZvaWQge1xuICAgIHRoaXMuc3RvcEtlZXBhbGl2ZSgpO1xuXG4gICAgdGhpcy50b2dnbGVJbnRlcnJ1cHRzKGZhbHNlKTtcblxuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ2lkbGVIYW5kbGUnKTtcbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCd0aW1lb3V0SGFuZGxlJyk7XG5cbiAgICB0aGlzLnNldElkbGluZyhmYWxzZSk7XG4gICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7XG5cbiAgICB0aGlzLmV4cGlyeS5sYXN0KG51bGwpO1xuICB9XG5cbiAgLypcbiAgICogRm9yY2VzIGEgdGltZW91dCBldmVudCBhbmQgc3RhdGUuXG4gICAqL1xuICB0aW1lb3V0KCk6IHZvaWQge1xuICAgIHRoaXMuc3RvcEtlZXBhbGl2ZSgpO1xuXG4gICAgdGhpcy50b2dnbGVJbnRlcnJ1cHRzKGZhbHNlKTtcblxuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ2lkbGVIYW5kbGUnKTtcbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCd0aW1lb3V0SGFuZGxlJyk7XG5cbiAgICB0aGlzLnNldElkbGluZyh0cnVlKTtcbiAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTtcbiAgICB0aGlzLmNvdW50ZG93biA9IDA7XG5cbiAgICB0aGlzLm9uVGltZW91dC5lbWl0KG51bGwpO1xuICB9XG5cbiAgLypcbiAgICogU2lnbmFscyB0aGF0IHVzZXIgYWN0aXZpdHkgaGFzIG9jY3VycmVkLlxuICAgKiBAcGFyYW0gZm9yY2UgLSBGb3JjZXMgd2F0Y2ggdG8gYmUgY2FsbGVkLCB1bmxlc3MgdGhleSBhcmUgdGltZWQgb3V0LlxuICAgKiBAcGFyYW0gZXZlbnRBcmdzIC0gT3B0aW9uYWwgc291cmNlIGV2ZW50IGFyZ3VtZW50cy5cbiAgICovXG4gIGludGVycnVwdChmb3JjZT86IGJvb2xlYW4sIGV2ZW50QXJncz86IGFueSk6IHZvaWQge1xuICAgIGlmICghdGhpcy5ydW5uaW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudGltZW91dFZhbCAmJiB0aGlzLmV4cGlyeS5pc0V4cGlyZWQoKSkge1xuICAgICAgdGhpcy50aW1lb3V0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMub25JbnRlcnJ1cHQuZW1pdChldmVudEFyZ3MpO1xuXG4gICAgaWYgKFxuICAgICAgZm9yY2UgPT09IHRydWUgfHxcbiAgICAgIHRoaXMuYXV0b1Jlc3VtZSA9PT0gQXV0b1Jlc3VtZS5pZGxlIHx8XG4gICAgICAodGhpcy5hdXRvUmVzdW1lID09PSBBdXRvUmVzdW1lLm5vdElkbGUgJiYgIXRoaXMuZXhwaXJ5LmlkbGluZygpKVxuICAgICkge1xuICAgICAgdGhpcy53YXRjaChmb3JjZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRJZGxpbmcodmFsdWU6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB0aGlzLmlkbGluZyA9IHZhbHVlO1xuICAgIHRoaXMuZXhwaXJ5LmlkbGluZyh2YWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIHRvZ2dsZVN0YXRlKCk6IHZvaWQge1xuICAgIHRoaXMuc2V0SWRsaW5nKCF0aGlzLmlkbGluZyk7XG5cbiAgICBpZiAodGhpcy5pZGxpbmcpIHtcbiAgICAgIHRoaXMub25JZGxlU3RhcnQuZW1pdChudWxsKTtcbiAgICAgIHRoaXMuc3RvcEtlZXBhbGl2ZSgpO1xuXG4gICAgICBpZiAodGhpcy50aW1lb3V0VmFsID4gMCkge1xuICAgICAgICB0aGlzLmNvdW50ZG93biA9IHRoaXMudGltZW91dFZhbDtcbiAgICAgICAgdGhpcy5kb0NvdW50ZG93bigpO1xuICAgICAgICB0aGlzLnNldFRpbW91dEludGVydmFsT3V0c2lkZVpvbmUoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuZG9Db3VudGRvd25JblpvbmUoKTtcbiAgICAgICAgfSwgMTAwMCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudG9nZ2xlSW50ZXJydXB0cyh0cnVlKTtcbiAgICAgIHRoaXMub25JZGxlRW5kLmVtaXQobnVsbCk7XG4gICAgICB0aGlzLnN0YXJ0S2VlcGFsaXZlKCk7XG4gICAgfVxuXG4gICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgnaWRsZUhhbmRsZScpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRUaW1vdXRJbnRlcnZhbE91dHNpZGVab25lKFxuICAgIGludGVydmFsRm46ICgpID0+IHZvaWQsXG4gICAgZnJlcXVlbmN5OiBudW1iZXJcbiAgKSB7XG4gICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIHRoaXMudGltZW91dEhhbmRsZSA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgaW50ZXJ2YWxGbigpO1xuICAgICAgfSwgZnJlcXVlbmN5KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgdG9nZ2xlSW50ZXJydXB0cyhyZXN1bWU6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBmb3IgKGNvbnN0IGludGVycnVwdCBvZiB0aGlzLmludGVycnVwdHMpIHtcbiAgICAgIGlmIChyZXN1bWUpIHtcbiAgICAgICAgaW50ZXJydXB0LnJlc3VtZSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaW50ZXJydXB0LnBhdXNlKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRFeHBpcnlEaWZmKHRpbWVvdXQ6IG51bWJlcik6IG51bWJlciB7XG4gICAgY29uc3Qgbm93OiBEYXRlID0gdGhpcy5leHBpcnkubm93KCk7XG4gICAgY29uc3QgbGFzdDogRGF0ZSA9IHRoaXMuZXhwaXJ5Lmxhc3QoKSB8fCBub3c7XG4gICAgcmV0dXJuIGxhc3QuZ2V0VGltZSgpIC0gbm93LmdldFRpbWUoKSAtIHRpbWVvdXQgKiAxMDAwO1xuICB9XG5cbiAgcHJpdmF0ZSBkb0NvdW50ZG93bkluWm9uZSgpOiB2b2lkIHtcbiAgICB0aGlzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgIHRoaXMuZG9Db3VudGRvd24oKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZG9Db3VudGRvd24oKTogdm9pZCB7XG4gICAgY29uc3QgZGlmZiA9IHRoaXMuZ2V0RXhwaXJ5RGlmZih0aGlzLnRpbWVvdXRWYWwpO1xuICAgIGlmIChkaWZmID4gMCkge1xuICAgICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgndGltZW91dEhhbmRsZScpO1xuICAgICAgdGhpcy5pbnRlcnJ1cHQodHJ1ZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmlkbGluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvdW50ZG93biA8PSAwKSB7XG4gICAgICB0aGlzLnRpbWVvdXQoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLm9uVGltZW91dFdhcm5pbmcuZW1pdCh0aGlzLmNvdW50ZG93bik7XG4gICAgdGhpcy5jb3VudGRvd24tLTtcbiAgfVxuXG4gIHByaXZhdGUgc2FmZUNsZWFySW50ZXJ2YWwoaGFuZGxlTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgaGFuZGxlID0gdGhpc1toYW5kbGVOYW1lXTtcbiAgICBpZiAoaGFuZGxlICE9PSBudWxsICYmIHR5cGVvZiBoYW5kbGUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXNbaGFuZGxlTmFtZV0pO1xuICAgICAgdGhpc1toYW5kbGVOYW1lXSA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGFydEtlZXBhbGl2ZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMua2VlcGFsaXZlU3ZjIHx8ICF0aGlzLmtlZXBhbGl2ZUVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5ydW5uaW5nKSB7XG4gICAgICB0aGlzLmtlZXBhbGl2ZVN2Yy5waW5nKCk7XG4gICAgfVxuXG4gICAgdGhpcy5rZWVwYWxpdmVTdmMuc3RhcnQoKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RvcEtlZXBhbGl2ZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMua2VlcGFsaXZlU3ZjIHx8ICF0aGlzLmtlZXBhbGl2ZUVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmtlZXBhbGl2ZVN2Yy5zdG9wKCk7XG4gIH1cblxuICAvKlxuICAgKiBDYWxsZWQgYnkgQW5ndWxhciB3aGVuIGRlc3Ryb3lpbmcgdGhlIGluc3RhbmNlLlxuICAgKi9cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zdG9wKCk7XG4gICAgdGhpcy5jbGVhckludGVycnVwdHMoKTtcbiAgfVxufVxuIl19